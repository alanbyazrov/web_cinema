{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row">
    <!-- –ü–æ—Å—Ç–µ—Ä —Ñ–∏–ª—å–º–∞ -->
    <div class="col-md-4 mb-4">
        <img src="{% if movie.image_url %}{{ movie.image_url }}{% else %}{% static 'images/movie-placeholder.jpg' %}{% endif %}"
             class="img-fluid rounded shadow" alt="{{ movie.title }}">
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–ª—å–º–µ -->
    <div class="col-md-8">
        <h1 class="display-5">{{ movie.title }} ({{ movie.year }})</h1>

        <div class="mb-3">
            {% if movie.director %}
            <span class="badge bg-secondary me-2">–†–µ–∂–∏—Å—Å–µ—Ä: {{ movie.director }}</span>
            {% endif %}
            {% if movie.country %}
            <span class="badge bg-info me-2">{{ movie.country }}</span>
            {% endif %}
        </div>

        <div class="mb-3">
            {% for genre in movie.genres.all %}
            <span class="badge bg-primary me-1">{{ genre.name }}</span>
            {% endfor %}
        </div>

        <!-- –†–µ–π—Ç–∏–Ω–≥ —Ñ–∏–ª—å–º–∞ -->
        <div class="mb-3">
            <h5>–û—Ü–µ–Ω–∫–∏:</h5>
            <div class="d-flex align-items-center gap-3">
                <span class="fs-5 text-success">üëç {{ like_count }}</span>
                <span class="fs-5 text-danger">üëé {{ dislike_count }}</span>
            </div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        {% if movie.description %}
        <div class="mb-4">
            <h5>–û–ø–∏—Å–∞–Ω–∏–µ:</h5>
            <p class="lead">{{ movie.description }}</p>
        </div>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ -->
        {% if user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞</h5>

                {% if user_liked %}
                <p class="text-success">–í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ üëç —ç—Ç–æ–º—É —Ñ–∏–ª—å–º—É</p>
                {% elif user_disliked %}
                <p class="text-danger">–í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ üëé —ç—Ç–æ–º—É —Ñ–∏–ª—å–º—É</p>
                {% endif %}

                <form method="post" action="{% url 'movies:rate_movie' movie.id %}">
                    {% csrf_token %}
                    <div class="d-flex gap-2">
                        {% if user_liked %}
                            <button type="submit" name="action" value="remove" class="btn btn-outline-secondary">
                                ‚ùå –£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É
                            </button>
                        {% else %}
                            <button type="submit" name="action" value="like"
                                    class="btn {% if user_liked %}btn-success{% else %}btn-outline-success{% endif %}">
                                üëç –ù—Ä–∞–≤–∏—Ç—Å—è
                            </button>
                            <button type="submit" name="action" value="dislike"
                                    class="btn {% if user_disliked %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                üëé –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">–í–∞—à –æ—Ç–∑—ã–≤</h5>

                {% if user_review %}
                <div class="alert alert-info">
                    <strong>–í–∞—à —Ç–µ–∫—É—â–∏–π –æ—Ç–∑—ã–≤:</strong>
                    <p class="mb-0">{{ user_review.text }}</p>
                    <small class="text-muted">–ù–∞–ø–∏—Å–∞–Ω: {{ user_review.created_at|date:"d.m.Y H:i" }}</small>
                </div>
                {% endif %}

                <form method="post" action="{% url 'movies:add_review' movie.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤:</label>
                        <textarea name="review_text" class="form-control" rows="4"
                                  placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –º–Ω–µ–Ω–∏–µ–º –æ —Ñ–∏–ª—å–º–µ..."
                                  maxlength="1000">{% if user_review %}{{ user_review.text }}{% endif %}</textarea>
                        <small class="text-muted">–ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        {% if user_review %}–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% else %}–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% endif %}
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <a href="{% url 'users:login' %}" class="alert-link">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º, –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!
        </div>
        {% endif %}
    </div>
</div>

<!-- –û—Ç–∑—ã–≤—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
{% if reviews %}
<div class="mt-5">
    <h3>–û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
    <div class="row">
        <div class="col-12">
            {% for review in reviews %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle text-muted">
                            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ review.user.phone }}
                        </h6>
                        <small class="text-muted">{{ review.created_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    <p class="card-text">{{ review.text }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- –ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã -->
{% if similar_movies %}
<div class="mt-5">
    <h3>–ü–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã</h3>
    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for similar_movie in similar_movies %}
        <div class="col">
            <div class="card h-100">
                <img src="{% if similar_movie.image_url %}{{ similar_movie.image_url }}{% else %}{% static 'images/movie-placeholder.jpg' %}{% endif %}"
                     class="card-img-top" alt="{{ similar_movie.title }}" style="height: 200px; object-fit: cover;">
                <div class="card-body">
                    <h5 class="card-title">{{ similar_movie.title }}</h5>
                    <p class="card-text text-muted">{{ similar_movie.year }}</p>
                    <div class="mb-2">
                        {% for genre in similar_movie.genres.all %}
                        <span class="badge bg-primary me-1">{{ genre.name }}</span>
                        {% endfor %}
                    </div>
                    <a href="{% url 'movies:movie_detail' similar_movie.id %}" class="btn btn-primary">–°–º–æ—Ç—Ä–µ—Ç—å</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}